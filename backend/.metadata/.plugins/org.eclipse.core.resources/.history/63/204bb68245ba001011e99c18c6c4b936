package com.example.crop.controller;

import com.example.crop.entity.Crop;
import com.example.crop.service.CropService;
import lombok.RequiredArgsConstructor;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/crops")
@RequiredArgsConstructor
public class CropController {

    private final CropService cropService;

    // ✅ Add crop (Farmer only)
    @PostMapping("/add")
    public ResponseEntity<?> addCrop(@RequestPart Crop crop,
                                     @RequestPart(required = false) MultipartFile image,
                                     @RequestHeader("Authorization") String authHeader) {
        return ResponseEntity.ok(cropService.addCropWithImage(crop, image, authHeader));
    }

    // ✅ Role-aware crop listing
    @GetMapping("/my")
    public ResponseEntity<?> getMyCrops(@RequestHeader("Authorization") String authHeader) {
        return ResponseEntity.ok(cropService.getCropsForUser(authHeader));
    }

    // ✅ Public browsing (dealers view only approved crops)
    @GetMapping("/all")
    public ResponseEntity<?> getAll(@RequestHeader(value = "Authorization", required = false) String authHeader) {
        return ResponseEntity.ok(cropService.getVisibleCrops(authHeader));
    }


    @GetMapping("/{id}")
    public ResponseEntity<?> getById(@PathVariable Long id) {
        Crop crop = cropService.getById(id);
        return crop != null ? ResponseEntity.ok(crop) : ResponseEntity.notFound().build();
    }

    @PutMapping("/{id}")
    public ResponseEntity<?> updateCrop(@PathVariable Long id,
                                        @RequestBody Crop crop,
                                        @RequestHeader("Authorization") String authHeader) {
        crop.setId(id);
        return ResponseEntity.ok(Map.of("message", "Crop updated", "data", cropService.updateCrop(crop, authHeader)));
    }

    @DeleteMapping("/{id}")
    public ResponseEntity<?> deleteCrop(@PathVariable Long id,
                                        @RequestHeader("Authorization") String authHeader) {
        cropService.deleteCrop(id, authHeader);
        return ResponseEntity.ok(Map.of("message", "Crop deleted successfully"));
    }
}

