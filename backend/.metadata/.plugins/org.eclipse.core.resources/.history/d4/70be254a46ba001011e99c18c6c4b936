package com.example.crop.service;

import com.example.crop.config.RabbitConfig;
import com.example.crop.entity.Crop;
import com.example.crop.entity.CropStatus;
import com.example.crop.events.CropPublishedEvent;
import com.example.crop.repository.CropRepository;
import com.example.crop.util.JwtUtil;

import org.hibernate.query.Page;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.awt.print.Pageable;
import java.io.IOException;
import java.nio.file.*;
import java.time.Instant;
import java.time.LocalDateTime;
import java.util.List;
import java.util.Map;
import java.util.UUID;

@Service
public class CropService {

    private final CropRepository repo;
    private final RabbitTemplate rabbitTemplate;
    private final JwtUtil jwtUtil;

    public CropService(CropRepository repo, RabbitTemplate rabbitTemplate, JwtUtil jwtUtil) {
        this.repo = repo;
        this.rabbitTemplate = rabbitTemplate;
        this.jwtUtil = jwtUtil;
    }

    // ✅ Add Crop (Farmer only)
    public Map<String, Object> addCropWithImage(Crop crop, MultipartFile image, String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        Long farmerId = jwtUtil.extractUserId(token);
        String role = jwtUtil.extractRole(token);

        if (!"FARMER".equalsIgnoreCase(role))
            throw new RuntimeException("Only FARMER can add crops");

        crop.setFarmerId(farmerId);
        crop.setCreatedAt(LocalDateTime.now());
        crop.setUpdatedAt(LocalDateTime.now());
        crop.setStatus(CropStatus.PENDING);

        if (image != null && !image.isEmpty()) {
            try {
                Path uploadDir = Paths.get("uploads");
                if (!Files.exists(uploadDir)) Files.createDirectories(uploadDir);
                String fileName = UUID.randomUUID() + "_" + image.getOriginalFilename();
                Path filePath = uploadDir.resolve(fileName);
                Files.copy(image.getInputStream(), filePath, StandardCopyOption.REPLACE_EXISTING);
                crop.setImageUrl("/uploads/" + fileName);
            } catch (IOException e) {
                throw new RuntimeException("Image upload failed: " + e.getMessage());
            }
        }

        Crop saved = repo.save(crop);

        // publish crop-added event
        CropPublishedEvent event = new CropPublishedEvent(
                saved.getId(), saved.getName(), saved.getType(),
                saved.getQuantity(), saved.getLocation(),
                saved.getPricePerUnit(), saved.getFarmerId(), Instant.now()
        );

        rabbitTemplate.convertAndSend(RabbitConfig.CROP_EXCHANGE, "crop.published." + saved.getName(), event);
        return Map.of("message", "Crop added successfully", "id", saved.getId());
    }

    // ✅ Get single crop
    public Crop getById(Long id) {
        return repo.findById(id).orElse(null);
    }

    // ✅ Update crop (only by owner farmer or admin)
    public Crop updateCrop(Crop updated, String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        Long userId = jwtUtil.extractUserId(token);
        String role = jwtUtil.extractRole(token);

        Crop existing = repo.findById(updated.getId())
                .orElseThrow(() -> new RuntimeException("Crop not found"));

        if (!"ADMIN".equalsIgnoreCase(role) && !existing.getFarmerId().equals(userId)) {
            throw new RuntimeException("Unauthorized to update this crop");
        }

        existing.setName(updated.getName());
        existing.setType(updated.getType());
        existing.setQuantity(updated.getQuantity());
        existing.setLocation(updated.getLocation());
        existing.setPricePerUnit(updated.getPricePerUnit());
        existing.setUpdatedAt(LocalDateTime.now());

        return repo.save(existing);
    }

    // ✅ Delete crop (only by owner farmer or admin)
    public void deleteCrop(Long id, String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        Long userId = jwtUtil.extractUserId(token);
        String role = jwtUtil.extractRole(token);

        Crop existing = repo.findById(id)
                .orElseThrow(() -> new RuntimeException("Crop not found"));

        if (!"ADMIN".equalsIgnoreCase(role) && !existing.getFarmerId().equals(userId)) {
            throw new RuntimeException("Unauthorized to delete this crop");
        }

        repo.deleteById(id);
    }

    // ✅ Get crops filtered by user role
    public List<Crop> getCropsForUser(String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        String role = jwtUtil.extractRole(token);
        Long userId = jwtUtil.extractUserId(token);

        switch (role.toUpperCase()) {
            case "FARMER":
                return repo.findByFarmerId(userId);
            case "DEALER":
                return repo.findByStatus(CropStatus.APPROVED);
            case "ADMIN":
                return repo.findAll();
            default:
                throw new RuntimeException("Unknown role: " + role);
        }
    }

    // ✅ Visible crops for browsing (Dealer/Admin/Farmer)
    public List<Crop> getVisibleCrops(String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        String role = jwtUtil.extractRole(token);

        if ("DEALER".equalsIgnoreCase(role)) {
            return repo.findByStatus(CropStatus.APPROVED);
        } else if ("FARMER".equalsIgnoreCase(role)) {
            Long farmerId = jwtUtil.extractUserId(token);
            return repo.findByFarmerId(farmerId);
        } else if ("ADMIN".equalsIgnoreCase(role)) {
            return repo.findAll();
        } else {
            throw new RuntimeException("Unauthorized user");
        }
    }
 // in CropService
    public Page<Crop> findVisible(Pageable pageable, String authHeader) {
        // if you don’t need role logic here, just approved:
        return CropRepository.findByStatus(CropStatus.APPROVED, pageable);
    }

    public Page<Crop> searchVisible(String q, Pageable pageable, String authHeader) {
        String like = "%" + q.toLowerCase() + "%";
        return CropRepository.searchApproved(like, pageable);
    }

}

