package com.cropdeal.payment.service;

import com.cropdeal.payment.config.RabbitConfig;
import com.cropdeal.payment.entity.Payment;
import com.cropdeal.payment.events.PaymentCompletedEvent;
import com.cropdeal.payment.repository.PaymentRepository;
import com.cropdeal.payment.util.JwtUtil;
import org.springframework.amqp.rabbit.core.RabbitTemplate;
import org.springframework.stereotype.Service;
import java.time.Instant;
import java.util.List;
import java.util.Map;

@Service
public class PaymentService {

    private final PaymentRepository repo;
    private final RabbitTemplate rabbitTemplate;
    private final JwtUtil jwtUtil;

    public PaymentService(PaymentRepository repo, RabbitTemplate rabbitTemplate, JwtUtil jwtUtil) {
        this.repo = repo;
        this.rabbitTemplate = rabbitTemplate;
        this.jwtUtil = jwtUtil;
    }

    public Map<String, Object> makePayment(Payment payment, String authHeader) {
        String token = authHeader.replace("Bearer ", "");
        Long dealerId = jwtUtil.extractUserId(token);
        String role = jwtUtil.extractRole(token);

        if (!"DEALER".equalsIgnoreCase(role))
            throw new RuntimeException("Only DEALER can make payments.");

        if (payment.getAmount() == null || payment.getAmount() <= 0)
            throw new RuntimeException("Invalid payment amount.");
        if (payment.getFarmerId() == null)
            throw new RuntimeException("Missing farmerId for payment.");
        if (payment.getCropId() == null)
            throw new RuntimeException("Missing cropId for payment.");

        payment.setDealerId(dealerId);
        payment.setStatus("SUCCESS");
        Payment saved = repo.save(payment);

        PaymentCompletedEvent event = new PaymentCompletedEvent(
                saved.getId(), saved.getDealerId(), saved.getFarmerId(),
                saved.getCropId(), saved.getAmount(), saved.getStatus(), Instant.now()
        );

        rabbitTemplate.convertAndSend(
                RabbitConfig.PAYMENT_EXCHANGE, "payment.completed." + saved.getId(), event
        );

        return Map.of("message", "Payment successful", "paymentId", saved.getId());
    }

    public List<Payment> getAllPayments() {
        return repo.findAll();
    }
}
