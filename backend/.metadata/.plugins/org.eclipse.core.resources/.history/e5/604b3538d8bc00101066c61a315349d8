package com.cropdeal.request.listener;

import com.cropdeal.request.config.RabbitConfig;
import com.cropdeal.request.entity.CropRequest;
import com.cropdeal.request.repository.CropRequestRepository;
import com.cropdeal.request.events.PaymentEvent;
import org.springframework.amqp.rabbit.annotation.RabbitListener;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.time.LocalDateTime;
import java.util.Optional;

@Component
public class PaymentEventListener {

    private final CropRequestRepository repo;

    public PaymentEventListener(CropRequestRepository repo) {
        this.repo = repo;
    }

    /**
     * ‚úÖ Listen on the queue name defined in RabbitConfig
     */
    @RabbitListener(queues = RabbitConfig.PAYMENT_QUEUE)
    @Transactional
    public void onPaymentCompleted(PaymentEvent event) {
        System.out.println("üéØ Received Payment Event: " + event);

        Long requestId = event.getRequestId();
        Double amount = event.getAmount();

        if (requestId == null) {
            System.err.println("‚ö†Ô∏è Payment event missing requestId, skipping update");
            return;
        }

        Optional<CropRequest> optional = repo.findById(requestId);
        if (optional.isPresent()) {
            CropRequest request = optional.get();
            request.setStatus("COMPLETED");
            request.setTotalAmount(amount);
            request.setCompletedAt(LocalDateTime.now());
            repo.save(request);

            System.out.println("‚úÖ Request " + requestId + " marked as COMPLETED.");
        } else {
            System.err.println("‚ùå No matching request found for requestId " + requestId);
        }
    }
}
