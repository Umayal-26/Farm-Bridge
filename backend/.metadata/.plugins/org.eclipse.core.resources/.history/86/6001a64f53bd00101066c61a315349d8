package com.cropdeal.payment.controller;

import com.cropdeal.payment.entity.Payment;
import com.cropdeal.payment.service.PaymentService;
import lombok.RequiredArgsConstructor;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/payments")   // <-- keep same base as gateway forwards
@RequiredArgsConstructor
public class PaymentController {

    private final PaymentService service;
    private final Logger log = LoggerFactory.getLogger(PaymentController.class);

    @PostMapping
    public ResponseEntity<?> makePayment(@RequestBody Payment payment,
                                         @RequestHeader(value = "Authorization", required = false) String authHeader,
                                         @RequestHeader(value = "X-User-Id", required = false) String xUserIdHeader) {
        // Accept either Authorization Bearer token or X-User-Id header for dev convenience.
        try {
            log.info("POST /api/payments - payload={} authHeaderPresent={} xUserId={}",
                    payment, authHeader != null, xUserIdHeader);
            Map<String, Object> result = service.makePayment(payment, authHeader);
            return ResponseEntity.ok(result);
        } catch (IllegalArgumentException iae) {
            // validation problems -> 400
            log.warn("Payment validation failed: {}", iae.getMessage());
            return ResponseEntity.badRequest().body(Map.of("message", iae.getMessage()));
        } catch (RuntimeException re) {
            // business errors from service -> 400 if message indicates validation, else 500
            String msg = re.getMessage() == null ? "Payment processing failed" : re.getMessage();
            log.error("Payment processing error: {}", msg, re);
            // if message contains "Amount" or "required", consider it a bad request
            if (msg.toLowerCase().contains("amount") || msg.toLowerCase().contains("required")) {
                return ResponseEntity.badRequest().body(Map.of("message", msg));
            }
            return ResponseEntity.status(500).body(Map.of("message", "Payment processing failed: " + msg));
        } catch (Exception ex) {
            log.error("Unexpected error while processing payment", ex);
            return ResponseEntity.status(500).body(Map.of("message", "Payment processing failed"));
        }
    }

    @GetMapping("/all")
    public ResponseEntity<?> allPayments() {
        return ResponseEntity.ok(service.getAllPayments());
    }
}
